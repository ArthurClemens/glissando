{"version":3,"file":"glissando.umd.js","sources":["../src/GlissandoModel.ts","../src/util.ts"],"sourcesContent":["import Stream from 'mithril-stream-standalone';\n\nimport type { Glissando } from './types';\n\ntype PatchFn = (state: Glissando.State) => Glissando.State;\n\nconst calculateNewIndex = (\n  state: Glissando.State,\n  index: number | undefined,\n) => {\n  if (index === undefined || Number.isNaN(index)) {\n    return {\n      newIndex: state.index,\n      shouldUpdate: false,\n    };\n  }\n  const newIndex = Math.min(index, state.count - 1);\n  const isValid = newIndex >= 0 && newIndex < state.count;\n  const shouldUpdate = isValid && newIndex !== state.index;\n  return {\n    newIndex,\n    shouldUpdate,\n  };\n};\n\nconst setIndex = (state: Glissando.State) => (\n  change: Glissando.IndexChange,\n) => {\n  const { newIndex, shouldUpdate } = calculateNewIndex(state, change.index);\n  return shouldUpdate\n    ? {\n        ...state,\n        ...(change.animate ? undefined : { index: newIndex }),\n        targetIndex: newIndex,\n        isAnimating: !!change.animate,\n      }\n    : state;\n};\n\nconst setLocation = (state: Glissando.State) => (\n  change: Glissando.LocationChange,\n) => {\n  if (!state.locations || state.locations.length === 0) {\n    return state;\n  }\n  let locationStr = change.location.toString();\n  let index = state.locations.indexOf(locationStr);\n  if (index === -1) {\n    // Location does not exist; default to first index\n    index = 0;\n    locationStr = state.locations[index];\n  }\n  const shouldAnimate =\n    state.location === undefined\n      ? false // don't animate if we are setting the first location\n      : change.animate !== false;\n  const newState = {\n    ...state,\n    location: locationStr,\n  };\n  const indexChange: Glissando.IndexChange = {\n    index,\n    animate: shouldAnimate,\n  };\n  return setIndex(newState)(indexChange);\n};\n\ntype IndexLocationChange = (index: number) => number;\n\nconst lookupLocation = (state: Glissando.State) => (\n  changeFn: IndexLocationChange,\n) => {\n  if (!state.locations || !state.location) {\n    return undefined;\n  }\n  const index = state.locations.indexOf(state.location);\n  if (index === -1) {\n    return undefined;\n  }\n  return state.locations[changeFn(index)];\n};\n\nconst getInitialState = (\n  {\n    index = 0,\n    count = 0,\n    sideViews = 1,\n    location,\n    locations,\n  }: Glissando.InitialState = {} as Glissando.InitialState,\n) => {\n  const slots = Array.from({ length: 1 + sideViews * 2 }, (_, i) => i).map(\n    (_, i) => i - sideViews,\n  );\n  const initialState: Glissando.State = {\n    targetIndex: index,\n    index,\n    count,\n    ...(Array.isArray(locations)\n      ? {\n          locations,\n          count: locations ? locations.length : 0,\n          location: locations[0],\n        }\n      : undefined),\n    ...(location\n      ? {\n          location,\n          index: Array.isArray(locations)\n            ? locations.indexOf(location) || index\n            : index,\n        }\n      : undefined),\n    isAnimating: false,\n    direction: 'ltr', // set by libs glissando-mithril etc\n    slots,\n    sideViews,\n  };\n  initialState.targetIndex = initialState.index;\n  return initialState;\n};\n\nexport const GlissandoModel = (\n  props: Glissando.InitialState = {} as Glissando.InitialState,\n) => {\n  const initialState = getInitialState(props);\n\n  const glissandoState = {\n    initialState,\n    actions: (update: Stream<PatchFn>) => ({\n      previous: ({ animate }: { animate?: boolean } = { animate: true }) => {\n        update((state: Glissando.State) =>\n          setIndex(state)({\n            index: state.index - 1,\n            animate: animate !== false,\n          }),\n        );\n      },\n      next: ({ animate }: { animate?: boolean } = { animate: true }) => {\n        update((state: Glissando.State) =>\n          setIndex(state)({\n            index: state.index + 1,\n            animate: animate !== false,\n          }),\n        );\n      },\n      goTo: ({\n        index,\n        location,\n        animate,\n      }: {\n        index?: number;\n        location?: Glissando.Location;\n        animate?: boolean;\n      }) => {\n        update((state: Glissando.State) => {\n          if (location) {\n            const change: Glissando.LocationChange = {\n              location,\n              animate,\n            };\n            return setLocation(state)(change);\n          }\n          if (index === undefined) {\n            return state;\n          }\n          const change: Glissando.IndexChange = {\n            index,\n            animate,\n          };\n          return setIndex(state)(change);\n        });\n      },\n      finalize: (index: number) => {\n        update((state: Glissando.State) =>\n          setIndex(state)({\n            index,\n            animate: false,\n          }),\n        );\n      },\n      setCount: (count: number) => {\n        update((state: Glissando.State) =>\n          setIndex({\n            ...state,\n            count,\n          })({ index: state.index }),\n        );\n      },\n      setDirection: (direction: Glissando.Direction) => {\n        update((state: Glissando.State) => ({\n          ...state,\n          direction,\n        }));\n      },\n      setLocations: (locations: Glissando.Location[]) => {\n        update((state: Glissando.State) => ({\n          ...state,\n          locations,\n          count: locations.length,\n        }));\n      },\n    }),\n\n    selectors: (states: Stream<Glissando.State>) => ({\n      hasNext: () => {\n        const state = states();\n        return state.index < state.count - 1;\n      },\n      hasPrevious: () => {\n        const state = states();\n        return state.index > 0;\n      },\n      isAnimating: () => {\n        const state = states();\n        return state.isAnimating;\n      },\n      getViewIndices: () => {\n        const state = states();\n        return state.slots.map(slotIndex => {\n          let index = slotIndex + state.index + 0;\n          if (slotIndex < 0 && state.targetIndex < state.index) {\n            index = slotIndex + state.targetIndex + 1;\n          } else if (slotIndex > 0 && state.targetIndex > state.index) {\n            index = slotIndex + state.targetIndex - 1;\n          }\n          return index;\n        });\n      },\n      getLocation: () => {\n        const state = states();\n        return lookupLocation(state)(index => index);\n      },\n      getNextLocation: () => {\n        const state = states();\n        return lookupLocation(state)(index => index + 1);\n      },\n      getPreviousLocation: () => {\n        const state = states();\n        return lookupLocation(state)(index => index - 1);\n      },\n    }),\n  };\n\n  const update: Stream<PatchFn> = Stream<PatchFn>();\n\n  const states: Glissando.States = Stream.scan(\n    (state: Glissando.State, patch: PatchFn) => patch(state),\n    {\n      ...glissandoState.initialState,\n    },\n    update,\n  );\n\n  // Debugging:\n  // states.map(state => console.log(JSON.stringify(state, null, 2)));\n\n  const actions = {\n    ...glissandoState.actions(update),\n  };\n\n  const selectors: Glissando.Selectors = {\n    ...glissandoState.selectors(states),\n  };\n\n  const changedStates: Glissando.ChangedStates = Stream.scan(\n    (state: Glissando.ChangedState, value) =>\n      JSON.stringify(state, null, 2) === JSON.stringify(value, null, 2)\n        ? Stream.SKIP\n        : value,\n    Stream.SKIP,\n    states,\n  );\n\n  const getChanges = Stream.lift(\n    value => value as Glissando.State,\n    changedStates,\n  );\n\n  return {\n    getState: states,\n    getChanges,\n    ...actions,\n    ...selectors,\n  } as Glissando.Model;\n};\n","import type { Glissando } from './types';\n\n/**\n * Returns the classname and style object for the current model state.\n * Usage:\n *\n * const { className, style } = getSliderStyle(getState());\n * ...\n * <div\n *   className={`glissando-slider ${className}`}\n *   style={style}\n * >\n */\nexport const getSliderStyle = (state: Glissando.State) => {\n  const slotCount = 2 * state.sideViews + 1;\n  const slotWidth = 100 / slotCount;\n  const direction = state.direction === 'rtl' ? 1 : -1;\n  let sliderTranslateX: number = direction * slotWidth * (state.sideViews + 0);\n  if (state.targetIndex > state.index) {\n    sliderTranslateX = direction * slotWidth * (state.sideViews + 1);\n  } else if (state.targetIndex < state.index) {\n    sliderTranslateX = direction * slotWidth * (state.sideViews - 1);\n  }\n\n  const style = {\n    width: `calc(${slotCount} * calc(100%))`,\n    transform: `translateX(${sliderTranslateX}%)`,\n    ...(!state.isAnimating\n      ? {\n          transitionDuration: '0ms',\n        }\n      : undefined),\n  };\n  const className = state.isAnimating ? 'glissando-animating' : '';\n  return { style, className };\n};\n"],"names":["update","change","states"],"mappings":"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"}